#!/bin/bash

# Get the directory where this app bundle is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BUNDLE_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"
WORKING_DIR="$(dirname "$BUNDLE_DIR")"

echo "üöÄ MultiPing v1.6 Installer"
echo "=============================="
echo ""
echo "üìù This installer will create a detailed log file for troubleshooting."
echo "   Log will be saved to: MultiPing-Installer.log"
echo ""

# Redirect all output to both console and log file
exec > >(tee MultiPing-Installer.log) 2>&1

echo "üöÄ MultiPing v1.6 Installer (Logging Enabled)"
echo "=============================="
echo ""

# Enable detailed logging
set -x

echo "üîç DEBUG INFO:"
echo "  Script Directory: $SCRIPT_DIR"
echo "  Bundle Directory: $BUNDLE_DIR"
echo "  Working Directory: $WORKING_DIR"
echo "  Current Directory: $(pwd)"
echo "  Current User: $(whoami)"
echo "  macOS Version: $(sw_vers -productVersion)"
echo ""

# Change to the working directory where the installer app is located
cd "$WORKING_DIR"
echo "  Changed to: $(pwd)"
echo ""

# Check if we're in the right place
echo "üîç CHECKING FILES:"
echo "  Looking for MultiPing-v1.6-release in: $(pwd)"
echo "  Directory contents:"
ls -la
echo ""

if [ ! -f "MultiPing-v1.6-release" ]; then
    echo "‚ùå Error: MultiPing executable not found!"
    echo ""
    echo "üîç TROUBLESHOOTING INFO:"
    echo "  Expected file: MultiPing-v1.6-release"
    echo "  Current directory: $(pwd)"
    echo "  Directory contents:"
    ls -la
    echo ""
    echo "  Parent directory contents:"
    ls -la ..
    echo ""
    echo "Please make sure this installer is in the same folder as:"
    echo "  - MultiPing-v1.6-release"
    echo "  - install.sh"
    echo "  - RELEASE_NOTES_v1.6.md"
    echo ""
    echo "Press any key to close..."
    read -n 1
    exit 1
fi

echo "üìù Making MultiPing executable..."
echo "  File permissions before:"
ls -la MultiPing-v1.6-release
echo ""

chmod +x MultiPing-v1.6-release

echo "  File permissions after:"
ls -la MultiPing-v1.6-release
echo ""

# Check if it's now executable
if [ -x "MultiPing-v1.6-release" ]; then
    echo "‚úÖ MultiPing is now executable!"
    echo ""
    echo "üéØ To run MultiPing:"
    echo "   ./MultiPing-v1.6-release"
    echo ""
    echo "üì± MultiPing will appear in your menubar (top-right of screen)"
    echo "   Click the menubar icon to access all features"
    echo ""
    echo "üìñ For more information, see RELEASE_NOTES_v1.6.md"
    echo ""
    echo "üöÄ Installation complete! You can now run MultiPing."
    echo ""
    echo "Press any key to close..."
    read -n 1
else
    echo "‚ùå Error: Failed to make MultiPing executable"
    echo ""
    echo "Press any key to close..."
    read -n 1
    exit 1
fi
